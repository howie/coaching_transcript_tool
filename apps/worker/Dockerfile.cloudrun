FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy source code and configuration
COPY src/ ./src/
COPY pyproject.toml requirements.txt ./

# Copy requirements and install dependencies
COPY apps/api-server/requirements.txt ./apps/api-server/
COPY apps/worker/health_server.py ./health_server.py

# Install Python dependencies
RUN pip install --no-cache-dir -r ./apps/api-server/requirements.txt
RUN pip install -e .

# Set Python path
ENV PYTHONPATH=/app/src:/app
ENV PORT=8080

# Create startup script
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Starting health server and Celery worker..."\n\
python health_server.py &\n\
exec celery -A coaching_assistant.core.celery_app worker --loglevel=info --concurrency=4\n' > /app/start.sh

RUN chmod +x /app/start.sh

# Health check (optional for Cloud Run)
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

# Start both health server and Celery worker
CMD ["/app/start.sh"]