FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install dependencies
COPY apps/api-server/requirements.txt /app/requirements.txt
COPY packages/core-logic /app/packages/core-logic

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install -e packages/core-logic

# Copy source code
COPY packages/core-logic/src /app/packages/core-logic/src
COPY apps/worker/health_server.py /app/health_server.py

# Set Python path
ENV PYTHONPATH=/app/packages/core-logic/src:$PYTHONPATH
ENV PORT=8080

# Create startup script
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Starting health server and Celery worker..."\n\
python health_server.py &\n\
exec celery -A coaching_assistant.core.celery_app worker --loglevel=info --concurrency=4\n' > /app/start.sh

RUN chmod +x /app/start.sh

# Health check (optional for Cloud Run)
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

# Start both health server and Celery worker
CMD ["/app/start.sh"]