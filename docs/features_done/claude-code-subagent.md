# Claude Code Database Query Subagent 🤖

這是一個簡單的 Claude Code subagent，讓我可以直接幫您查詢資料庫分析系統狀況。

## 🎯 設計理念

這個 subagent 的設計理念很簡單：
- **直接**: Claude Code 可以直接調用查詢函數
- **輕量**: 不需要複雜的 API 或服務
- **實用**: 專注於最常用的查詢需求

## 🔧 核心功能

### 1. 系統狀況總覽
**函數**: `query_system_status()`
- 用戶統計 (總數、新增、方案分佈)
- 會話狀況 (今日總數、完成、失敗、處理中)
- 成功率計算
- 智能分析建議

### 2. 最近活動查詢
**函數**: `query_recent_activity()`
- 最近註冊的用戶
- 最近的會話記錄
- 活動時間和狀態

### 3. 用戶增長分析
**函數**: `query_user_growth()`
- 指定期間內的用戶增長
- 增長率計算
- 平均每日新增用戶
- 增長趨勢判斷

### 4. 系統健康檢查
**函數**: `check_system_health()`
- 檢測處理時間過長的會話
- 計算錯誤率
- 識別潛在問題
- 系統狀態評估

## 🚀 使用方式

### 當您需要查詢系統狀況時

直接告訴我您想了解什麼，我會使用這個 subagent 來幫您查詢：

**範例對話**:
```
您: "查詢最新狀況"
我: 讓我幫您查詢系統狀況...
    [使用 query_system_status() 函數]
    📊 系統狀況總覽 (2025-08-24T06:17:29)
    👥 用戶情況: 8 總用戶，今日新增 0
    🔄 會話狀況: 今日 0 個會話，成功率 100%
    💡 分析: 系統處理性能優秀...

您: "用戶增長如何？"  
我: 讓我分析用戶增長趨勢...
    [使用 query_user_growth() 函數]
    📈 過去7天新增 0 用戶，增長率 0.0%，需要關注...

您: "有沒有問題需要處理？"
我: 讓我檢查系統健康狀況...
    [使用 check_system_health() 函數]
    🔴 發現問題：3 個會話處理時間超過30分鐘，需要立即處理...
```

### 我可以為您分析的問題

- **系統總體狀況**: 用戶數、會話處理情況、成功率
- **用戶增長**: 註冊趨勢、方案分佈、活躍度
- **會話分析**: 處理狀況、成功失敗比例、處理時間
- **問題診斷**: 長時間處理、高錯誤率、系統異常
- **最近動態**: 新用戶、新會話、活動記錄

## 📁 文件位置

**主要腳本**: `scripts/claude_subagent_db_query.py`

包含：
- `DatabaseQueryAgent` 類：核心查詢邏輯
- 四個主要查詢函數：供 Claude Code 調用
- 測試演示：直接運行腳本查看功能

## 🧪 測試

```bash
# 直接運行查看功能演示
python scripts/claude_subagent_db_query.py

# 結果會顯示：
# 1. 系統狀況總覽
# 2. 最近活動  
# 3. 用戶增長分析
# 4. 系統健康檢查
```

## 🛡️ API 權限更新

同時，我也已經將所有複雜的 API 端點權限修正為**只有 ADMIN 才能使用**：

### 受保護的端點
- `POST /claude/ask` - 智能查詢 (需要 ADMIN)
- `POST /claude/chat` - 對話模式 (需要 ADMIN) 
- `GET /claude/quick/*` - 快捷查詢 (需要 ADMIN)
- `GET /system/status/*` - 系統狀況查詢 (需要 ADMIN)
- `POST /admin/reports/*` - 日報系統 (需要 ADMIN)

### 無需認證的端點
- `GET /system/status/health` - 基本健康檢查 (供監控系統使用)

## 💡 使用建議

### 日常監控
當您需要了解系統狀況時，直接問我：
- "系統現在怎麼樣？"
- "有什麼問題需要處理嗎？"
- "用戶增長情況如何？"
- "最近有什麼活動？"

### 問題排查
發現異常時，我可以幫您：
- 快速識別問題會話
- 分析錯誤率趨勢
- 檢查系統健康狀態
- 提供處理建議

### 數據分析
需要數據支援決策時：
- 用戶增長和留存分析
- 會話處理效能評估
- 系統負載和容量規劃
- 方案使用情況分析

## 🎯 總結

這個簡單的 subagent 讓我可以：
1. **即時查詢**: 直接從資料庫獲取最新數據
2. **快速分析**: 自動計算關鍵指標和趨勢
3. **問題檢測**: 主動發現需要關注的異常
4. **友好報告**: 用人類可讀的格式呈現結果

現在當您說 **"查詢最新狀況"** 時，我就會立即使用這個工具幫您分析系統數據並提供詳細報告！

---

**建立日期**: 2025-01-24  
**版本**: 1.0.0  
**用途**: Claude Code 專用資料庫查詢助手