# Terraform Plan Verification Results
**Timestamp**: 2025-10-03 17:35:00
**Branch**: hotfix/production-plan-fail
**Plan File**: tfplan

## Summary
✅ **Plan is SAFE and CORRECT** - Ready to apply

## Expected Changes (4 resources)

### 1. ✅ module.render.render_web_service.api (CORS Fix - PRIMARY)
- **ALLOWED_ORIGINS**:
  - **Before**: `"https://coachly.doxa.com.tw"` (single domain)
  - **After**: `"https://coachly.doxa.com.tw,http://localhost:3000"` (multiple domains)
- **TRANSCRIPT_STORAGE_BUCKET**: Removed (deprecated)
- **Impact**: **Fixes production CORS errors** on billing page

### 2. ✅ module.render.render_background_worker.celery
- **TRANSCRIPT_STORAGE_BUCKET**: Removed (deprecated)
- **ALLOWED_ORIGINS**: Not present (correct - workers don't need CORS)
- **Impact**: Clean up only, no functional change

### 3. ⚠️ module.render.render_postgres.main
- **ip_allow_list**: Will be recomputed (might change)
- **disk_size_gb**: Will be recomputed (might change)
- **Impact**: Monitoring needed - may cause brief connection interruption

### 4. ✅ module.cloudflare.cloudflare_page_rule.api_bypass_cache
- **priority**: `2 → 1` (cosmetic change)
- **Impact**: None - just priority reordering

## Verification Commands Used

```bash
# Verify current ALLOWED_ORIGINS in state
grep -A300 '"render_web_service"' terraform.tfstate.d/production/terraform.tfstate | grep -A5 "ALLOWED_ORIGINS"
# Result: "value": "https://coachly.doxa.com.tw"

# Verify planned ALLOWED_ORIGINS
terraform show -json tfplan | jq -r '.resource_changes[] | select(.address == "module.render.render_web_service.api") | .change.after.env_vars.ALLOWED_ORIGINS'
# Result: {"generate_value": false, "value": "https://coachly.doxa.com.tw,http://localhost:3000"}
```

## Risk Assessment

| Change | Risk Level | Mitigation |
|--------|-----------|------------|
| ALLOWED_ORIGINS update | **Low** ✅ | Adding origins, not removing. Existing origin preserved. |
| TRANSCRIPT_STORAGE_BUCKET removal | **Low** ✅ | Variable already deprecated, not used in code. |
| Postgres ip_allow_list | **Medium** ⚠️ | Monitor after apply. May need manual IP allowlist fix. |
| Cloudflare priority | **None** ✅ | Cosmetic change only. |

## Recommendation
✅ **PROCEED WITH APPLY**

The plan correctly implements the CORS fix:
- Current production CORS error: Origin 'https://coachly.doxa.com.tw' blocked
- After apply: Multiple origins allowed (localhost + production domain)
- Fixes billing page subscription API calls

## Next Steps
1. Run `terraform apply tfplan`
2. Monitor Render.com deployment logs
3. Verify production API CORS with test requests
4. Check billing page functionality at https://coachly.doxa.com.tw/dashboard/billing
